<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WASM Test</title>
    <style>
        body {
            font-family: monospace;
            background: #0d1117;
            color: #c9d1d9;
            padding: 2rem;
        }
        pre { background: #161b22; padding: 1rem; border-radius: 4px; overflow-x: auto; }
        .success { color: #3fb950; }
        .error { color: #f85149; }
    </style>
</head>
<body>
    <h1>ðŸ§ª WASM Module Test</h1>
    <pre id="output"></pre>
    
    <script src="lib/agle_wasm.js"></script>
    <script>
        const output = document.getElementById('output');
        
        function log(msg) {
            console.log(msg);
            const line = document.createElement('div');
            if (msg.includes('âœ“')) {
                line.innerHTML = msg.replace(/âœ“/g, '<span class="success">âœ“</span>');
            } else if (msg.includes('âœ—')) {
                line.innerHTML = msg.replace(/âœ—/g, '<span class="error">âœ—</span>');
            } else {
                line.textContent = msg;
            }
            output.appendChild(line);
        }
        
        (async () => {
            try {
                log('=== WASM Module Diagnostics ===');
                log('');
                
                log('ðŸ“‹ Environment:');
                log(`  window.location.href = ${window.location.href}`);
                log(`  typeof WebAssembly = ${typeof WebAssembly}`);
                log(`  typeof fetch = ${typeof fetch}`);
                log('');
                
                log('ðŸ” Module Status:');
                log(`  typeof window.AGLEWasm = ${typeof window.AGLEWasm}`);
                
                if (typeof window.AGLEWasm !== 'undefined') {
                    log(`  typeof AGLEWasm.init = ${typeof window.AGLEWasm.init}`);
                    
                    log('');
                    log('â³ Initializing WASM...');
                    const adapter = await window.AGLEWasm.init();
                    
                    if (!adapter) {
                        log('âœ— AGLEWasm.init() returned null/falsy');
                        log('  This usually means fetch failed or WebAssembly.instantiate failed');
                        return;
                    }
                    
                    log('âœ“ AGLEWasm.init() succeeded');
                    log(`  Adapter keys: ${Object.keys(adapter).sort().join(', ')}`);
                    
                    // Test getBytes
                    if (adapter.getBytes) {
                        try {
                            const bytes = adapter.getBytes(8);
                            const hexStr = Array.from(bytes)
                                .map(b => b.toString(16).padStart(2, '0'))
                                .join(' ');
                            log(`âœ“ getBytes(8) = ${hexStr}`);
                        } catch (e) {
                            log(`âœ— getBytes() failed: ${e.message}`);
                        }
                    }
                    
                    // Test fpError
                    if (adapter.fpError || adapter.agle_fp_error_raw) {
                        try {
                            const fpFunc = adapter.fpError || adapter.agle_fp_error_raw;
                            const errors = [];
                            for (let i = 0; i < 5; i++) {
                                errors.push(fpFunc(Math.random()));
                            }
                            log(`âœ“ agle_fp_error_raw() works`);
                            log(`  Sample errors: ${errors.map(e => e.toExponential(2)).join(', ')}`);
                        } catch (e) {
                            log(`âœ— fpError() failed: ${e.message}`);
                        }
                    } else {
                        log('âœ— fpError/agle_fp_error_raw not found in adapter');
                    }
                    
                } else {
                    log('âœ— window.AGLEWasm is not defined');
                    log('  Check that <script src="lib/agle_wasm.js"></script> is loaded');
                }
                
            } catch (e) {
                log(`âœ— Fatal error: ${e.message}`);
                log(e.stack);
            }
        })();
    </script>
</body>
</html>
