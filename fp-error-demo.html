<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IEEE-754 Error Visualization | AGLE</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Space Grotesk', -apple-system, sans-serif;
            background: linear-gradient(135deg, #0d1117 0%, #161b22 100%);
            color: #c9d1d9;
            padding: 2rem;
            min-height: 100vh;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        h1 {
            font-size: 2rem;
            background: linear-gradient(135deg, #58a6ff, #79c0ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1rem;
        }
        
        .theory {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .formula {
            font-family: 'Georgia', serif;
            font-size: 1.2rem;
            text-align: center;
            margin: 1rem 0;
            color: #79c0ff;
        }
        
        .demo {
            background: #0d1117;
            border: 2px solid #30363d;
            border-radius: 8px;
            padding: 2rem;
        }
        
        button {
            background: linear-gradient(135deg, #1f6feb, #58a6ff);
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(88, 166, 255, 0.4);
        }
        
        #results {
            margin-top: 2rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }
        
        .error-value {
            color: #f85149;
            font-weight: bold;
        }
        
        .success {
            color: #3fb950;
        }
        
        .histogram {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(40px, 1fr));
            gap: 4px;
            margin-top: 1rem;
        }
        
        .bar {
            background: linear-gradient(180deg, #58a6ff, #1f6feb);
            border-radius: 4px;
            transition: height 0.3s;
        }
        
        .back-link {
            display: inline-block;
            margin-bottom: 1rem;
            color: #58a6ff;
            text-decoration: none;
        }
        
        .back-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">‚Üê Voltar ao RNG</a>
        
        <h1>üî¨ Demonstra√ß√£o: Erro de Ponto Flutuante IEEE-754</h1>
        
        <div class="theory">
            <h2>Teoria</h2>
            <p>O erro de ponto flutuante √© a diferen√ßa entre um valor ideal (precis√£o infinita) e sua representa√ß√£o real em IEEE-754:</p>
            <div class="formula">Œµ = x<sub>real</sub> - round<sub>IEEE</sub>(x)</div>
            <p>Este erro √© <strong>pequeno, mas real</strong> e <strong>n√£o-determin√≠stico</strong> no hardware. A AGLE amplifica esses erros via mapas ca√≥ticos para extrair entropia.</p>
        </div>
        
        <div class="demo">
            <h3>Experimento Interativo</h3>
            <p>Clique para gerar 10.000 erros de ponto flutuante e visualizar a distribui√ß√£o:</p>
            <button id="runDemo">‚ñ∂ Executar Demonstra√ß√£o</button>
            
            <div id="results"></div>
        </div>
    </div>
    
    <script src="lib/agle_wasm.js"></script>
    <script>
        const runBtn = document.getElementById('runDemo');
        const resultsDiv = document.getElementById('results');
        
        runBtn.addEventListener('click', async () => {
            resultsDiv.innerHTML = '<p class="success">‚öôÔ∏è Inicializando WASM...</p>';
            
            // Carregar WASM (se dispon√≠vel)
            let fpErrorFunc = null;
            let wasmLoaded = false;
            try {
                console.log('[Demo] Calling AGLEWasm.init()...');
                const wasmAdapter = await window.AGLEWasm.init();
                
                if (wasmAdapter && wasmAdapter.agle_fp_error_raw) {
                    fpErrorFunc = wasmAdapter.agle_fp_error_raw;
                    wasmLoaded = true;
                    console.log('[Demo] WASM loaded successfully');
                    resultsDiv.innerHTML += '<p class="success">‚úì WASM carregado! Usando agle_fp_error_raw()</p>';
                } else {
                    console.warn('[Demo] Adapter returned but missing agle_fp_error_raw');
                    resultsDiv.innerHTML += '<p>‚ö†Ô∏è WASM n√£o exp√µe agle_fp_error_raw. Usando simula√ß√£o sens√≠vel.</p>';
                }
            } catch (e) {
                console.error('[Demo] WASM load failed:', e);
                resultsDiv.innerHTML += `<p>‚ö†Ô∏è WASM n√£o dispon√≠vel (${e.message}). Usando simula√ß√£o sens√≠vel.</p>`;
            }
            
            // Gerar erros
            resultsDiv.innerHTML += '<p>üìä Gerando 10.000 erros...</p>';
            const errors = [];
            const samples = 10000;
            
            for (let i = 0; i < samples; i++) {
                let error;
                
                if (fpErrorFunc) {
                    // WASM: erro real IEEE-754 via C volatile operations
                    error = fpErrorFunc(Math.random());
                } else {
                    // Fallback: Simula√ß√£o sens√≠vel de erro (n√£o pode usar volatile em JS)
                    // Usa opera√ß√µes que causam pequenas perturba√ß√µes
                    const x = Math.random();
                    const y1 = x + 1e-16;
                    const y2 = x * (1 + 1e-15);
                    error = Math.abs((y1 - x) + (y2 - x)) / 2;
                }
                
                if (error > 0) errors.push(error);
            }
            
            // Estat√≠sticas
            const mean = errors.reduce((a, b) => a + b, 0) / samples;
            const variance = errors.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / samples;
            const stdDev = Math.sqrt(variance);
            
            resultsDiv.innerHTML += `
                <h4>Resultados</h4>
                <p><strong>Amostras coletadas:</strong> ${errors.length.toLocaleString()} / ${samples}</p>
                <p><strong>Modo:</strong> ${wasmLoaded ? 'üîß WASM (IEEE-754 real)' : 'üìù Simula√ß√£o JS (aproxima√ß√£o)'}</p>
                <p><strong>M√©dia (Œº):</strong> <span class="error-value">${mean.toExponential(6)}</span></p>
                <p><strong>Desvio Padr√£o (œÉ):</strong> <span class="error-value">${stdDev.toExponential(6)}</span></p>
                <p><strong>Primeiros 10 erros:</strong></p>
                <pre>${errors.slice(0, 10).map(e => e.toExponential(6)).join('\n')}</pre>
            `;
            
            // Histograma simplificado
            const bins = 20;
            const binCounts = new Array(bins).fill(0);
            const min = Math.min(...errors);
            const max = Math.max(...errors);
            const range = max - min;
            
            errors.forEach(e => {
                const binIndex = Math.min(bins - 1, Math.floor(((e - min) / range) * bins));
                binCounts[binIndex]++;
            });
            
            const maxCount = Math.max(...binCounts);
            const histogramHTML = binCounts.map(count => {
                const height = (count / maxCount) * 100;
                return `<div class="bar" style="height: ${height}px" title="${count} amostras"></div>`;
            }).join('');
            
            resultsDiv.innerHTML += `
                <h4>Distribui√ß√£o</h4>
                <div class="histogram">${histogramHTML}</div>
            `;
        });
    </script>
</body>
</html>
